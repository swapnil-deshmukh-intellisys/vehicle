<script>
    const preSelectedJobcardVehicleDamage = [
        {% for vehd in jobcard_obj.jobcard_vehicle_damage.all %}
        '{{ vehd.vehicledamage.id|escapejs }}'{% if not forloop.last %}, {% endif %}
        {% endfor %}
    ];

    $(document).ready(function () {
        // Initialize variables
        let vehicleDamages = [];
        const vehicleDamageSelect = $('#vehicleDamage');
        const $vehicleDamageForm = $('#vehicleDamageModal form');
        const $saveBtn = $('#saveVehicleDamageBtn');
        const vehicleType = '{{ jobcard_obj.vehicle_type }}';  // Get vehicle type from template context

        // Function to load vehicle damages
        function loadVehicleDamages(selectAfterLoad = null) {
            return new Promise((resolve) => {
                if (!vehicleType) {
                    console.warn('Vehicle type is not specified');
                    vehicleDamageSelect.empty();
                    resolve();
                    return;
                }

                // Get current selections before making the AJAX call
                let currentSelections = [...preSelectedJobcardVehicleDamage]; // Start with preselected values

                // If we're adding a new damage, include it in the current selections
                if (selectAfterLoad) {
                    if (Array.isArray(selectAfterLoad)) {
                        selectAfterLoad.forEach(id => {
                            if (!currentSelections.includes(id)) {
                                currentSelections.push(id);
                            }
                        });
                    } else if (!currentSelections.includes(selectAfterLoad)) {
                        currentSelections.push(selectAfterLoad);
                    }
                }

                $.ajax({
                    url: '{% url "list_vehicle_damages" %}',
                    type: 'GET',
                    data: {
                        vehicletype: vehicleType
                    },
                    success: function (response) {
                        if (response.status === 'success') {
                            vehicleDamages = response.data || [];
                            populateVehicleDamageSelect(vehicleDamages, currentSelections);
                        } else {
                            console.error('Error loading vehicle damages:', response.message);
                            toastr.error('Failed to load vehicle damages');
                        }
                        resolve(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error loading vehicle damages:', error);
                        toastr.error('Failed to load vehicle damages. Please refresh the page.');
                        resolve();
                    }
                });
            });
        }

        // Function to populate vehicle damage select
        function populateVehicleDamageSelect(damageList, selectedValues = []) {
            // Store current scroll position
            const scrollTop = $(document).scrollTop();

            // Destroy existing Select2 instance if it exists
            if ($.fn.select2 && vehicleDamageSelect.hasClass('select2-hidden-accessible')) {
                vehicleDamageSelect.select2('destroy');
            }

            // Clear existing options
            vehicleDamageSelect.empty();

            // Add new options
            damageList.forEach(function (damage) {
                vehicleDamageSelect.append($('<option>', {
                    value: damage.id,
                    text: damage.text
                }));
            });

            // Reinitialize Select2
            vehicleDamageSelect.select2({
                placeholder: 'Select Vehicle Damage(s)',
                allowClear: true,
                width: '100%',
                dropdownParent: $('body'),
                closeOnSelect: false,
                dropdownCssClass: 'vehicle-damage-select-dropdown',
                templateResult: function (data) {
                    if (data.loading) return data.text;
                    return $('<div>').text(data.text);
                },
                templateSelection: function (data) {
                    return data.text;
                }
            });

            // Set selected values if provided
            if (selectedValues && selectedValues.length > 0) {
                // Ensure all values are strings for comparison
                const stringValues = selectedValues.map(String);
                vehicleDamageSelect.val(stringValues).trigger('change');
            }

            // Restore scroll position
            $(document).scrollTop(scrollTop);

            // Add custom "Add New" option to the dropdown
            vehicleDamageSelect.on('select2:open', function () {
                setTimeout(function () {
                    if ($('.select2-dropdown .add-new-vehicle-damage-option').length === 0) {
                        const addNewOption = $('<div class="select2-results__option select2-results__option--highlighted add-new-vehicle-damage-option" style="color: #0d6efd; font-weight: bold; cursor: pointer;">+ Add New Vehicle Damage</div>');
                        $('.select2-dropdown .select2-results').prepend(addNewOption);
                    }
                }, 10);
            });

            // Handle click on the custom Add New option
            $(document).off('click', '.add-new-vehicle-damage-option').on('click', '.add-new-vehicle-damage-option', function (e) {
                e.preventDefault();
                e.stopPropagation();
                vehicleDamageSelect.select2('close');
                $vehicleDamageForm[0].reset();
                $vehicleDamageForm.find('.is-invalid').removeClass('is-invalid');
                $vehicleDamageForm.find('.invalid-feedback').remove();
                const modal = new bootstrap.Modal(document.getElementById('vehicleDamageModal'));
                modal.show();
                $('input', $vehicleDamageForm).first().focus();
            });
        }

        // Handle form submission
        $vehicleDamageForm.on('submit', function (e) {
            e.preventDefault();
            $vehicleDamageForm.find('.is-invalid').removeClass('is-invalid');
            $vehicleDamageForm.find('.invalid-feedback').remove();

            // Get the form data
            const damageName = $('#vehicleDamageName').val().trim();

            // Validate required fields
            if (!damageName) {
                $('#vehicleDamageName').addClass('is-invalid')
                    .after('<div class="invalid-feedback">Damage name is required</div>');
                return;
            }

            if (!vehicleType) {
                toastr.error('Vehicle type is not specified');
                return;
            }

            const $submitBtn = $vehicleDamageForm.find('button[type="submit"]');
            const originalBtnText = $submitBtn.html();
            $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');

            // Prepare form data
            const formData = new FormData(this);
            formData.append('vehicletype', vehicleType);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

            $.ajax({
                url: '{% url "save_vehicle_damage" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function (response) {
                    if (response.status === 'success') {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('vehicleDamageModal'));
                        if (modal) {
                            modal.hide();
                        }

                        // Get the new damage ID and text from the response
                        const newDamageId = response.data && response.data.id ? response.data.id.toString() : null;
                        const newDamageText = response.data && response.data.text ? response.data.text : '';

                        if (newDamageId && newDamageText) {
                            // Reload the damages list to ensure we have the latest data
                            loadVehicleDamages(newDamageId).then(() => {
                                toastr.success('Vehicle damage added successfully');
                            });
                        }
                    } else {
                        toastr.error(response.message || 'Failed to add vehicle damage');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to add vehicle damage. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                        if (xhr.responseJSON.errors) {
                            Object.entries(xhr.responseJSON.errors).forEach(([field, messages]) => {
                                const $field = $(`[name="${field}"]`);
                                $field.addClass('is-invalid');
                                $field.next('.invalid-feedback').remove();
                                $field.after(`<div class="invalid-feedback">${Array.isArray(messages) ? messages.join(' ') : messages}</div>`);
                            });
                        }
                    }
                    toastr.error(errorMessage);
                },
                complete: function () {
                    $submitBtn.prop('disabled', false).html(originalBtnText);
                }
            });
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize modal events
        $('#vehicleDamageModal').on('hidden.bs.modal', function () {
            $vehicleDamageForm[0].reset();
            $vehicleDamageForm.find('.is-invalid').removeClass('is-invalid');
            $vehicleDamageForm.find('.invalid-feedback').remove();
        });

        // Handle Enter key in form inputs
        $vehicleDamageForm.on('keypress', 'input', function (e) {
            if (e.which === 13) {
                e.preventDefault();
                $vehicleDamageForm.submit();
            }
        });

        // Initialize vehicle damages when document is ready
        loadVehicleDamages();
    });
</script>