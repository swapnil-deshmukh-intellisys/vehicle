<script>
    $(document).ready(function () {
        // Store customer voices in an array
        let customerVoices = [];

        // Load customer voices when page loads
        loadCustomerVoices();

        // Load customer voices when modal is shown
        $('#customerVoiceModal').on('shown.bs.modal', function () {
            loadCustomerVoices();
        });

        // Reset form when modal is closed
        $('#customerVoiceModal').on('hidden.bs.modal', function () {
            $('#customerVoiceInputField').val('').removeClass('is-invalid');
            $('#customerVoiceAddBtn').html('<i class="fas fa-plus me-1"></i> Add');
        });

        // Handle form submission
        $('#customerVoiceForm').on('submit', function (e) {
            e.preventDefault();
            const voiceText = $('#customerVoiceInputField').val().trim();

            if (!voiceText) {
                toastr.warning('Please enter a customer voice');
                return;
            }

            // Show loading state
            const $submitBtn = $('#customerVoiceAddBtn');
            const originalBtnText = $submitBtn.html();
            $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');

            saveCustomerVoice(voiceText, function () {
                $submitBtn.prop('disabled', false).html(originalBtnText);
                $('#customerVoiceModal').modal('hide');
            });
        });

        // Load customer voices
        function loadCustomerVoices() {
            const jobcardNumber = '{{ jobcard_obj.jobcard_number }}';
            const $list = $('#customerVoiceList');

            $.ajax({
                url: '/get-jobcard-customer-voice/',
                type: 'GET',
                data: { jobcard_number: jobcardNumber },
                success: function (response) {
                    if (response.status === 'success') {
                        customerVoices = response.customer_voice || [];
                        renderCustomerVoices($list);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading customer voices:', error);
                    toastr.error('Failed to load customer voices');
                }
            });
        }

        // Render customer voices in the list
        function renderCustomerVoices($list) {
            $list = $list || $('#customerVoiceList');
            $list.empty();

            // Container styling
            $list.css({
                'max-height': '200px',
                'overflow-y': 'auto',
                'overflow-x': 'hidden',
                'background': '#fff'
            });

            if (customerVoices.length === 0) {
                $list.append(`
                <div class="text-muted small p-3 text-center">
                    <i class="fas fa-comment-alt me-25"></i> No customer voices added yet. Click to "Add Voice".
                </div>
            `);
                return;
            }

            customerVoices.forEach((voice, index) => {
                const $item = $(`
                <div class="voice-item d-flex align-items-center justify-content-between px-25 py-25 border-bottom" 
                     data-id="${voice.id}"
                     style="transition: background-color 0.2s;">
                    <div class="d-flex align-items-center" style="flex: 1; min-width: 0;">
                        <span class="text-muted me-25" style="width: 1.5rem; flex-shrink: 0;">${index + 1}.</span>
                        <span class="text-truncate">${escapeHtml(voice.customer_voice)}</span>
                    </div>
                    <button type="button" 
                            class="btn btn-sm btn-link text-danger p-0 delete-voice" 
                            data-id="${voice.id}" 
                            style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0.7;"
                            title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
                $list.append($item);
            });

            // Remove bottom border from last item
            $list.find('.voice-item:last-child').css('border-bottom', 'none');

            // Show scrollbar only if more than 2 items
            if (customerVoices.length <= 2) {
                $list.css('max-height', 'none').css('overflow-y', 'hidden');
            } else {
                $list.css('max-height', '200px').css('overflow-y', 'auto');
            }
        }

        // Save new customer voice
        function saveCustomerVoice(voiceText, callback) {
            const jobcardNumber = '{{ jobcard_obj.jobcard_number }}';

            $.ajax({
                url: '/api/save/jobcard/customer-voice/',
                type: 'POST',
                data: {
                    jobcard_number: jobcardNumber,
                    customer_voice: voiceText,
                    csrfmiddlewaretoken: getCookie('csrftoken')
                },
                success: function (response) {
                    if (response.status === 'success') {
                        toastr.success('Customer voice added successfully');
                        loadCustomerVoices();
                        $('#customerVoiceInputField').val('');
                    } else {
                        const errorMsg = response.message || 'Failed to save customer voice';
                        toastr.error(errorMsg);
                    }
                    if (typeof callback === 'function') callback();
                },
                error: function (xhr, status, error) {
                    const errorMsg = xhr.responseJSON?.message || 'Failed to save customer voice';
                    console.error('Error saving customer voice:', error);
                    toastr.error(errorMsg);
                    if (typeof callback === 'function') callback();
                }
            });
        }

        // Delete customer voice
        function deleteCustomerVoice(id) {
            if (!confirm('Are you sure you want to delete this voice?')) {
                return;
            }

            $.ajax({
                url: '/delete-jobcard-customer-voice/',
                type: 'POST',
                data: {
                    item_id: id,
                    csrfmiddlewaretoken: getCookie('csrftoken')
                },
                success: function (response) {
                    if (response.status === 'success') {
                        toastr.success('Customer voice deleted successfully');
                        loadCustomerVoices();
                    } else {
                        const errorMsg = response.message || 'Failed to delete customer voice';
                        toastr.error(errorMsg);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error deleting customer voice:', error);
                    toastr.error('Failed to delete customer voice');
                }
            });
        }

        // Handle delete button click
        $(document).on('click', '.delete-voice', function (e) {
            e.stopPropagation();
            const id = $(this).data('id');
            deleteCustomerVoice(id);
        });

        // Add hover effect
        $(document).on('mouseenter', '.voice-item', function () {
            $(this).css('background-color', '#f8f9fa');
            $(this).find('.delete-voice').css('opacity', '1');
        }).on('mouseleave', '.voice-item', function () {
            $(this).css('background-color', '');
            $(this).find('.delete-voice').css('opacity', '0.7');
        });

        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>