{% extends "index.html" %}

{% block title %}c-txn-estimates{% endblock %}

{% block style %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* Hide default date format placeholder */
    input[type="date"].empty-date:not(:focus):before {
        content: attr(placeholder);
        color: #6e6b7b;
        width: 100%;
    }
    
    input[type="date"].empty-date:not(:focus)::-webkit-datetime-edit {
        color: transparent;
    }
    
    input[type="date"].empty-date:focus::-webkit-datetime-edit {
        color: #6e6b7b;
    }
    
    /* Select2 Customization */
    .select2-container--default .select2-selection--single {
        height: 31px;
        font-size: 0.875rem;
        border: 1px solid #d8d6de;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 31px;
        padding-left: 8px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 30px;
    }
    
    .select2-dropdown {
        border: 1px solid #d8d6de;
        border-radius: 0.357rem;
    }
    
    .select2-container--default .select2-search--dropdown .select2-search__field {
        border: 1px solid #d8d6de;
        border-radius: 0.357rem;
        padding: 0.438rem 1rem;
    }
    
    .select2-results__option {
        padding: 0.5rem 1rem;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #7367f0;
    }
</style>
{% endblock %}

{% load custom_filters %}
{% block content %}
<div class="app-content content ">
        <div class="content-overlay"></div>
        <div class="header-navbar-shadow"></div>
        <div class="content-wrapper container-xxl p-0">
            <div class="content-header row">
                <div class="content-header-left col-md-9 col-12 mb-2">
                    <div class="row breadcrumbs-top">
                        <div class="col-12">
                            <h2 class="content-header-title float-start mb-0">Estimates</h2>
                            <div class="breadcrumb-wrapper">
                                <ol class="breadcrumb">
                                    {% if jobcard_obj %}                                     
                                    <li class="breadcrumb-item"><a href="{%url 'r-txn-job-sheets' %}">Jobcards</a>
                                    </li>
                                    {% else %}                                     
                                    <li class="breadcrumb-item"><a href="{%url 'r-txn-estimates' %}">List Estimates</a>
                                    </li>
                                    {% endif %}
                                    <li class="breadcrumb-item active">Create Estimates
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content-header-right text-md-end col-md-3 col-12 d-md-block d-none">
                    <div class="mb-1 breadcrumb-right">
                        <!-- <div class="dropdown">
                            <button class="btn-icon btn btn-success btn-round btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i data-feather="grid"></i></button>
                            <div class="dropdown-menu dropdown-menu-end"><a class="dropdown-item" href="app-todo.html"><i class="me-1" data-feather="check-square"></i><span class="align-middle">Todo</span></a><a class="dropdown-item" href="app-chat.html"><i class="me-1" data-feather="message-square"></i><span class="align-middle">Chat</span></a><a class="dropdown-item" href="app-email.html"><i class="me-1" data-feather="mail"></i><span class="align-middle">Email</span></a><a class="dropdown-item" href="app-calendar.html"><i class="me-1" data-feather="calendar"></i><span class="align-middle">Calendar</span></a></div>
                        </div> -->
                    </div>
                </div>
            </div>
            <div class="content-body"> 
                <section  id="c-txn-estimates">
                    <div class="row">
                        <div class="col-xl-9 col-md-8 col-12">
                            <div class="card">
                                <div class="card-body">
                                    <form method="post" id="customerSearchForm">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-12 col-md-6 mb-1">
                                                <div class="row d-flex align-items-end">
                                                    <div class="col-md-8 mb-1">                                                  
                                                        <label class="form-label" for="phone">Phone <span class="text-danger">*</span></label>
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text"><i data-feather='smartphone'></i></span>
                                                            <input type="text" class="form-control" name="phone" id="phone" pattern="[0-9]{10}" title="Please enter a 10-digit mobile number" placeholder="Enter phone to search" required/>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 mb-1">
                                                        <button class="btn btn-icon btn-gradient-primary" type="submit" id="searchCustomerBtn" title="Search">
                                                            <i data-feather="search"></i>
                                                        </button>
                                                        <button class="btn btn-icon btn-gradient-info" type="button" data-bs-toggle="modal" data-bs-target="#c-prf-customers-modal">
                                                            <i data-feather="plus-square"></i>
                                                        </button>
                                                    </div>
                                                </div> 

                                            </div>
                                        </div>
                                    </form>
                                
                                    <form method="post" action="{% url 'c-txn-estimates' %}{% if jobcard_obj %}?jobcard_id={{ jobcard_obj.id }}{% endif %}">
                                        {% csrf_token %}
                                        <div class="row"> 
                                            <input type="hidden" name="customerid" id="customerId">
                                            <div class="col-12 col-md-4 mb-1">  
                                                <label class="form-label" for="customer">Customer<span class="text-danger">*</span></label>
                                                <div class="input-group input-group-merge">
                                                    <span class="input-group-text"><i data-feather='user'></i></span>
                                                    <input type="text" class="form-control" name="customername" id="customerName" required>
                                                </div> 
                                                <small class="text-muted">Search phone for customer</small>
                                            </div>
                                            <div class="col-12 col-md-8 mb-1">    
                                                <div class="row d-flex align-items-center">
                                                    <div class="col-8">                                            
                                                        <label class="form-label" for="vehicle">Vehicle<span class="text-danger">*</span></label>
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text">&#x1F3CD;</span>
                                                            <select class="form-select border-start-0" name="vehicle" id="vehicleSelect" required>
                                                                <option value=""></option>
                                                            </select>
                                                        </div>
                                                        <small class="text-muted">Search phone to load vehicles</small>
                                                    </div>
                                                    <div class="col-4">
                                                        <button class="btn btn-gradient-info" type="button" data-bs-toggle="modal" data-bs-target="#c-prf-vehicles-modal" id="addVehicleButton" disabled>
                                                            <i data-feather="plus-square"></i>
                                                            <small>Add Vehicles</small>
                                                        </button>                                                         
                                                    </div>
                                                </div>  
                                            </div>
                                            <div class="col-12 col-md-4 mb-1" id="estimatedatediv" style="display: none;">  
                                                <label class="form-label" for="estimatedate">Estimate Date<span class="text-danger">*</span></label>                                                
                                                <input type="date" class="form-control" name="estimatedate" id="estimatedate">
                                            </div>
                                            <div class="col-12 col-md-4 mb-1" id="ponumberdiv" style="display: none;">  
                                                <label class="form-label" for="pono">PO No.</label>                                                
                                                <input type="text" class="form-control" name="pono">
                                            </div>
                                            <div class="col-12 col-md-4 mb-1" id="podatediv" style="display: none;">  
                                                <label class="form-label" for="podate">PO Date</label>
                                                <input type="date" class="form-control empty-date" name="podate" id="podate">
                                            </div>
                                            
                                            <div class="col-12 mb-1">                                                                                                
                                                <div class="divider divider-start">
                                                    <div class="divider-text d-flex align-items-center">
                                                        <span class="fw-bold me-2">Services:</span>                                                         
                                                        <button class="btn btn-sm btn-outline-primary waves-effect me-1" data-repeater-create="fromdb-service" type="button">
                                                            <i data-feather='list' class="me-25"></i>
                                                            <span>Select Service</span>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success waves-effect" data-repeater-create="fromuser-service" type="button">
                                                            <i data-feather='plus' class="me-25"></i>
                                                            <span>Add Service</span>
                                                        </button>
                                                    </div>
                                                </div> 
                                                <table class="table mb-0 table-sm table-striped table-hover">
                                                    <thead>
                                                        <tr>
<th>Name</th>
                                                            <th>Qty</th>
                                                            <th>Value</th>
                                                            <th>Tax (%)</th>
                                                            <th>Discount (%)</th>
                                                            <th>Action</th>
                                                    </thead>
                                                    <tbody data-repeater-list="fromdb-service">
                                                        <tr data-repeater-item>
                                                            <td>
<select class="form-select form-select-sm select2-searchable" name="fromdb_servicename">
                                                                    <option value="" hidden selected>Select service</option>
                                                                    {% for i in service_objs %}
                                                                    <option value="{{i.id}}">{{i.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <input type="number" class="form-control form-control-sm" name="fromdb_servicequantity" value="1" min="1" placeholder="Qty">
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text">₹</span><input type="number" class="form-control form-control-sm" name="fromdb_servicevalue" step="1" min="0" placeholder="Enter Service Value"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="percent"></i></span><input type="number" class="form-control form-control-sm" name="fromdb_servicetax" step="0.01" min="0" placeholder="Enter Service Tax"></div>
                                                            </td>
                                                            <td>                                                                
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="gift"></i></span><input type="number" class="form-control form-control-sm" name="fromdb_servicediscount" step="0.01" min="0" placeholder="Enter Service Discount"></div>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-icon rounded-circle btn-flat-danger waves-effect" data-repeater-delete="fromdb-service" type="button">
                                                                    <i data-feather='trash-2'></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                    <tbody data-repeater-list="fromuser-service">
                                                        <tr data-repeater-item>
                                                            <td>
                                                                <input type="text" class="form-control form-control-sm" name="fromuser_servicename" placeholder="Enter Service Name">
                                                            </td>
                                                            <td>
                                                                <input type="number" class="form-control form-control-sm" name="fromuser_servicequantity" value="1" min="1" placeholder="Qty">
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text">₹</span><input type="number" class="form-control form-control-sm" name="fromuser_servicevalue" step="1" min="0" placeholder="Enter Service Value"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="percent"></i></span><input type="number" class="form-control form-control-sm" name="fromuser_servicetax" step="0.01" min="0" placeholder="Enter Service Tax"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="gift"></i></span><input type="number" class="form-control form-control-sm" name="fromuser_servicediscount" step="0.01" min="0" placeholder="Enter Service Discount"></div>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-icon rounded-circle btn-flat-danger waves-effect" data-repeater-delete="fromuser-service" type="button">
                                                                    <i data-feather='trash-2'></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>                                            
                                            <div class="col-12 mb-1">                                                                                                
                                                <div class="divider divider-start">
                                                    <div class="divider-text d-flex align-items-center">
                                                        <span class="fw-bold me-2">Parts:</span>                                                         
                                                        <button class="btn btn-sm btn-outline-primary waves-effect me-1" data-repeater-create="fromdb-part" type="button">
                                                            <i data-feather='list' class="me-25"></i>
                                                            <span>Select Part</span>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success waves-effect" data-repeater-create="fromuser-part" type="button">
                                                            <i data-feather='plus' class="me-25"></i>
                                                            <span>Add Part</span>
                                                        </button>
                                                    </div>
                                                </div> 
                                                <table class="table mb-0 table-sm table-striped table-hover">
                                                    <thead>
                                                        <tr>
<th>Name</th>
                                                            <th>Qty</th>
                                                            <th>Value</th>
                                                            <th>Tax (%)</th>
                                                            <th>Discount (%)</th>
                                                            <th>Action</th>
                                                    </thead>
                                                    <tbody data-repeater-list="fromdb-part">
                                                        <tr data-repeater-item>
                                                            <td>
                                                                <select class="form-select form-select-sm select2-searchable" name="fromdb_partname">
                                                                    <option value="" hidden selected>Select part</option>
                                                                    {% for i in product_catalogues_objs %}
                                                                    <option value="{{i.id}}">{{i.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <input type="number" class="form-control form-control-sm" name="fromdb_partquantity" value="1" min="1" placeholder="Qty">
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text">₹</span><input type="number" class="form-control form-control-sm" name="fromdb_partvalue" step="1" min="0" placeholder="Enter Part Value"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="percent"></i></span><input type="number" class="form-control form-control-sm" name="fromdb_parttax" step="0.01" min="0" placeholder="Enter Part Tax"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="gift"></i></span><input type="number" class="form-control form-control-sm" name="fromdb_partdiscount" step="0.01" min="0" placeholder="Enter Part Discount"></div>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-icon rounded-circle btn-flat-danger waves-effect" data-repeater-delete="fromdb-part" type="button">
                                                                    <i data-feather="trash-2"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                    <tbody data-repeater-list="fromuser-part">
                                                        <tr data-repeater-item>
                                                            <td>
                                                                <input type="text" class="form-control form-control-sm" name="fromuser_partname" placeholder="Enter Part Name">
                                                            </td>
                                                            <td>
                                                                <input type="number" class="form-control form-control-sm" name="fromuser_partquantity" value="1" min="1" placeholder="Qty">
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text">₹</span><input type="number" class="form-control form-control-sm" name="fromuser_partvalue" step="1" min="0" placeholder="Enter Part Value"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="percent"></i></span><input type="number" class="form-control form-control-sm" name="fromuser_parttax" step="0.01" min="0" placeholder="Enter Part Tax"></div>
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm"><span class="input-group-text"><i data-feather="gift"></i></span><input type="number" class="form-control form-control-sm" name="fromuser_partdiscount" step="0.01" min="0" placeholder="Enter Part Discount"></div>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-icon rounded-circle btn-flat-danger waves-effect" data-repeater-delete="fromuser-part" type="button">
                                                                    <i data-feather="trash-2"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <!-- Hidden field to store total amount -->
                                            <input type="hidden" name="amount" id="estimate-total-amount" value="0">
                                            
                                            <div class="col-12 text-center">
                                                <button type="submit" class="btn btn-sm btn-primary me-1 waves-effect waves-float waves-light">Submit</button>
                                                <button type="reset" class="btn btn-sm btn-outline-secondary waves-effect">Reset</button>
                                            </div>
                                        </div> 
                                    </form>    
                                
                                    <!-- Create Customers Modal -->
                                    <div class="modal fade text-start" id="c-prf-customers-modal" tabindex="-1" aria-labelledby="c-prf-customers-modal-label" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <small class="modal-title" id="c-prf-customers-modal-label">Add Customer</small>
                                                    <button type="button" class="btn-close p-50" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form method="post" id="customerForm">
                                                        {% csrf_token %}
                                                        <div class="row">                                  
                                                            <div class="col-12 col-md-4 mb-1">
                                                                <label class="form-label" for="phone">Phone<span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" name="phone" id="modalPhone" pattern="[0-9]{10}" title="Please enter a 10-digit mobile number" required/>
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="name">Name<span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" name="name" required>
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">
                                                                <label class="form-label" for="email">Email</label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text">@</span>                                                 
                                                                    <input type="email" class="form-control trimwhitespace" name="email" />
                                                                </div>
                                                            </div> 
                                                            <div class="col-12 col-md-6 mb-1">                                                                
                                                                <label class="form-label" for="gst">GST</label>
                                                                <input type="text" class="form-control" name="gst">
                                                            </div>   
                                                            <div class="col-12 col-md-6 mb-1">
                                                                <label class="form-label" for="pincode">Pincode</label>
                                                                <input type="text" class="form-control" name="pincode" pattern="[0-9]{6}" title="Please enter a 6-digit pincode" />
                                                            </div>
                                                            <div class="col-12 mb-1">                                                                
                                                                <label class="form-label" for="address">Address</label>
                                                                <textarea class="form-control" name="address"></textarea>
                                                            </div>
                                                            <div class="col-12 text-end">                                                 
                                                                <button type="submit" class="btn btn-sm btn-success">Submit</button>
                                                            </div>
                                                        </div>
                                                    </form>    
                                                </div>                                                 
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Create Customers Modal --> 

                                    <!-- Create Vehicle Modal -->
                                    <div class="modal fade text-start" id="c-prf-vehicles-modal" tabindex="-1" aria-labelledby="c-prf-vehicles-modal-label" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <small class="modal-title" id="c-prf-vehicles-modal-label">Create Vehicle</small>
                                                    <button type="button" class="btn-close p-50" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form method="post" id="vehicleForm" enctype="multipart/form-data" data-url="{% url 'c-prf-vehicles' 0 %}">
                                                        {% csrf_token %}
                                                        <div class="row">                                  
                                                            <div class="col-12 col-md-4 mb-1">
                                                                <label class="form-label" for="model">Model<span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" name="model" required/>
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="make">Make</label>
                                                                <input type="text" class="form-control" name="make">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="license_plate_no">License Plate No.</label>
                                                                <input type="text" class="form-control" name="license_plate_no">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="external_bikeid">External Bikeid</label>
                                                                <input type="text" class="form-control" name="external_bikeid">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="registration_no">Registration No.</label>
                                                                <input type="text" class="form-control" name="registration_no">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="year_of_manufacture">Year Of Manufacture</label>
                                                                <input type="text" class="form-control" name="year_of_manufacture" placeholder="e.g. 2025" pattern="^(19\\d{2}|20[0-1]\\d|202[0-5])$" title="Enter a valid 4-digit year between 1900 and 2025" maxlength="4" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4);">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="fuel_type">Fuel Type</label>
                                                                <input type="text" class="form-control" name="fuel_type">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="transmission_type">Transmission Type</label>
                                                                <input type="text" class="form-control" name="transmission_type">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="engine_no">Engine No.</label>
                                                                <input type="text" class="form-control" name="engine_no">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="chassis_no">Chassis No.</label>
                                                                <input type="text" class="form-control" name="chassis_no">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="vin_no">Vin No.</label>
                                                                <input type="text" class="form-control" name="vin_no">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="color">Color</label>
                                                                <input type="text" class="form-control" name="color">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="reg_state">Registration State</label>
                                                                <input type="text" class="form-control" name="reg_state">
                                                            </div>
                                                            <div class="col-12 col-md-4 mb-1">                                                                
                                                                <label class="form-label" for="reg_exp">Registration Expiry</label>
                                                                <input type="date" class="form-control" name="reg_exp">
                                                            </div>
                                                            <div class="col-12 mb-1">
                                                                <label class="form-label" for="upload_image">Upload Image</label>
                                                                <input type="file" class="form-control" name="upload_image" id="c-prf-vehicles-img" 
                                                                    accept="image/*" 
                                                                    onchange="validateImage(['image/jpeg', 'image/png'], 200, 200, 'c-prf-vehicles-img', 'c-prf-vehicles-img-msg', 'c-prf-vehicles-img-subbtn')">
                                                                <small id="c-prf-vehicles-img-msg" class="form-text"></small>
                                                            </div>
                                                            <div class="col-12 text-end">                                                            
                                                                <button type="submit" class="btn btn-sm btn-success" id="c-prf-vehicles-img-subbtn">Submit</button>
                                                            </div>
                                                        </div>
                                                    </form>    
                                                </div>                                                 
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Create Vehicle Modal -->                              
                                </div>                                                               
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-4 col-12">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="fw-bolder text-primary mb-0">Estimate Summary</h4>
                                    </div>
                                    
                                    <div class="estimate-summary">
                                        <div class="row g-0">
                                            <div class="col-12">
                                                <span class="text-muted">Subtotal:</span>
                                                <span class="fw-bold float-end" id="summary-subtotal">INR 0.00</span>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-0 mt-1">
                                            <div class="col-12">
                                                <span class="text-muted">Discount:</span>
                                                <span class="fw-bold float-end" id="summary-discount">INR 0.00</span>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-0 mt-1">
                                            <div class="col-12">
                                                <span class="text-muted">Taxable Amount:</span>
                                                <span class="fw-bold float-end" id="summary-taxable">INR 0.00</span>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-0 mt-1">
                                            <div class="col-12">
                                                <span class="text-muted">Tax:</span>
                                                <span class="fw-bold float-end" id="summary-tax">INR 0.00</span>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-0 mt-3 pt-2 border-top">
                                            <div class="col-12">
                                                <span class="text-primary fw-bold">Estimate Total:</span>
                                                <span class="fs-5 fw-bolder text-dark float-end" id="summary-total">INR 0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize feather icons
        feather.replace();
        
        // ----------------------- Variables -----------------------
        const customerSearchForm = document.getElementById('customerSearchForm');
        const customerName = document.getElementById('customerName');
        const customerId = document.getElementById('customerId');
        const vehicleSelect = document.getElementById('vehicleSelect'); // Vehicle select element
        const vehicleForm = document.getElementById('vehicleForm');
        const customerForm = document.getElementById('customerForm');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const searchUrl = "{% url 's-prf-customers-vehicles' %}";
        const createCustomerUrl = "{% url 'c-prf-customers' %}";
        const addVehicleButton = document.querySelector('button[data-bs-toggle="modal"][data-bs-target="#c-prf-vehicles-modal"]'); // Button reference
    
        // ----------------------- Common Functions -----------------------
    
        /**
         * Show toast notification
         * @param {string} type - success, info, warning, error
         * @param {string} message - Message to display
         */
        const showToast = (type, message) => {
            toastr[type](message, type.toUpperCase(), {
                closeButton: true,
                tapToDismiss: false,
                progressBar: true,
                showMethod: 'fadeIn',
                hideMethod: 'fadeOut',
                timeOut: 3000
            });
        };
    
        /**
         * Update vehicle form action URL based on selected customer ID
         * @param {number} IDCustomer 
         */
        const updateVehicleFormAction = (IDCustomer) => {
            const baseActionUrl = vehicleForm.dataset.url; // Example: /c-prf-vehicles/0/
            const updatedUrl = baseActionUrl.replace(/\/\d+\/?$/, `/${IDCustomer}/`);
            vehicleForm.setAttribute('action', updatedUrl);  // Set the action attribute
        };
    
        /**
         * Populate the vehicle select options dynamically
         * @param {Array} vehicles 
         */
        const updateVehicleOptions = (vehicles) => {
            vehicleSelect.innerHTML = ''; // Reset options
            
            if (vehicles && vehicles.length > 0) {
                const getJobcardCustomerPhone = '{{jobcard_obj.vehicle.id}}';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Vehicle';
                vehicleSelect.appendChild(defaultOption);

                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    if (parseInt(getJobcardCustomerPhone) === parseInt(vehicle.id)) {
                        option.selected = true;
                    }
                    option.textContent = `${vehicle.license_plate_no} - ${vehicle.jobcardbrand} - ${vehicle.jobcardmodel}`;
                    vehicleSelect.appendChild(option);
                });

                //vehicleSelect.disabled = false; // Enable select if vehicles are found
            } else {
                const noVehiclesOption = document.createElement('option');
                noVehiclesOption.value = '';
                noVehiclesOption.textContent = '';
                vehicleSelect.appendChild(noVehiclesOption);
                //vehicleSelect.disabled = true; // Disable select if no vehicles
            }
        };
    
        /**
         * Toggle estimate date row visibility and required field
         * @param {boolean} isCustomerFound
         */
        const toggleEstimateDateRow = (isCustomerFound) => {        
            const estimateDateDiv = document.getElementById('estimatedatediv');
            const ponumberDiv = document.getElementById('ponumberdiv');
            const podateDiv = document.getElementById('podatediv');
            const estimateDateInput = document.getElementById('estimatedate');
            if (isCustomerFound) {
                // Set current date as default value
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                estimateDateInput.value = formattedDate;
                
                // Show the date fields
                estimateDateDiv.style.display = 'block';
                ponumberDiv.style.display = 'block';
                podateDiv.style.display = 'block';
                estimateDateInput.setAttribute('required', 'required');
            } else {
                estimateDateDiv.style.display = 'none';
                ponumberDiv.style.display = 'none';
                podateDiv.style.display = 'none';
                estimateDateInput.removeAttribute('required');
            }
        };
    
        /**
         * Enable/Disable Add Vehicle button based on customer existence
         * @param {boolean} isCustomerFound
         */
        const toggleAddVehicleButton = (isCustomerFound) => {
            if (addVehicleButton) {
                if (isCustomerFound) {
                    addVehicleButton.disabled = false; // Enable button
                } else {
                    addVehicleButton.disabled = true; // Disable button
                }
            }
        };
    
        // ----------------------- API Handlers -----------------------
    
        /**
         * Search customer by phone number
         * @param {string} phone 
         */
        const handleCustomerSearch = async (phone) => {
            try {
                const response = await fetch(searchUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ phone })
                });
    
                const data = await response.json();
    
                if (data.status) {
                    // showToast('success', data.message);
                    customerName.value = data.data.name;
                    customerId.value = data.data.id;
                    updateVehicleFormAction(data.data.id);
    
                    // Fetch and update vehicle options for the customer
                    updateVehicleOptions(data.data.vehicles);
    
                    // Show the estimate date row and make it required
                    toggleEstimateDateRow(true);
                    // Enable the Add Vehicle button
                    toggleAddVehicleButton(true);
                } else {
                    showToast('info', data.message);
                    customerName.value = '';
                    customerId.value = '';
                    document.getElementById('modalPhone').value = phone;
                    // Remove the action attribute from the vehicle form if customer is not found
                    vehicleForm.removeAttribute('action');
                    vehicleSelect.innerHTML = `<option value=""></option>`; // Reset vehicle select
                    //vehicleSelect.disabled = true; // Disable if no customer found
                    
                    // Hide the estimate date row and remove the required attribute
                    toggleEstimateDateRow(false);
                    // Disable the Add Vehicle button
                    toggleAddVehicleButton(false);
                }
            } catch (error) {
                showToast('error', `Something went wrong: ${error}`);
            }
        };

        /**
         * Create a new customer
         * @param {FormData} formData 
         */
        const handleCustomerCreate = async (formData) => {
            try {
                const response = await fetch(createCustomerUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                });

                const data = await response.json();

                if (data.status) {
                    showToast('success', data.message);

                    // Close and reset modal
                    const customerModal = bootstrap.Modal.getInstance(document.getElementById('c-prf-customers-modal'));
                    customerModal.hide();
                    customerForm.reset();
                } else {
                    showToast('error', data.message);
                }
            } catch (error) {
                showToast('error', `Something went wrong: ${error}`);
            }
        };

        /**
         * Create a new vehicle
         * @param {FormData} formData 
         */
        const handleVehicleCreate = async (formData) => {
            try {
                const response = await fetch(vehicleForm.action, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                });

                const data = await response.json();

                if (data.status) {
                    showToast('success', data.message);

                    // Close and reset modal
                    const vehicleModal = bootstrap.Modal.getInstance(document.getElementById('c-prf-vehicles-modal'));
                    vehicleModal.hide();
                    vehicleForm.reset();
                } else {
                    showToast('error', data.message);
                }
            } catch (error) {
                showToast('error', `Something went wrong: ${error}`);
            }
        };

    
        // ----------------------- Event Listeners -----------------------

        const getJobcardCustomerPhone = '{{jobcard_obj.customer.phone}}';
        if (getJobcardCustomerPhone) {
            const phone = document.getElementById('phone');
            phone.value = getJobcardCustomerPhone;
            handleCustomerSearch(getJobcardCustomerPhone);
        }
    
        // Customer search form submit
        customerSearchForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const phone = document.getElementById('phone').value.trim();
            if (phone) handleCustomerSearch(phone);
        });
    
        // Add new customer form submit
        customerForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(customerForm);
            handleCustomerCreate(formData);
        });
    
        // Add new vehicle form submit
        vehicleForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(vehicleForm);
            handleVehicleCreate(formData);
        });

        // ----------------------- Part Repeter -----------------------
        
        function initRepeater(listSelector, createSelector, deleteAttr) {
            const list = $(`[data-repeater-list="${listSelector}"]`);

            // Save a clean template and remove all initial rows
            const template = list.find('[data-repeater-item]').first().clone(true);
            template.find('input, select').val('').removeAttr('required');
            list.empty();

            // Add new row
            $(`[data-repeater-create="${createSelector}"]`).on('click', function () {
                const newItem = template.clone(true);
                newItem.find('input, select').each(function () {
                    $(this).val('');
                    $(this).attr('required', 'required');
                });
                list.append(newItem);
                feather.replace(); // Refresh feather icons
            });

            // Delete row
            $(document).on('click', `[data-repeater-delete="${deleteAttr}"]`, function () {
                const item = $(this).closest('[data-repeater-item]');
                item.find('input, select').val('').removeAttr('required'); // Clear values and remove required
                item.remove();
                
                // Update estimate summary after deleting a row
                updateEstimateSummary();
            });
        }

        // Function to calculate and update estimate summary
        function updateEstimateSummary() {
            let subtotal = 0;
            let taxAmount = 0;
            let discountAmount = 0;
            let taxableAmount = 0;
            
            // Calculate service amounts
            // From database services
            document.querySelectorAll('tbody[data-repeater-list="fromdb-service"] tr').forEach(row => {
                const valueInput = row.querySelector('input[name="fromdb_servicevalue"]');
                const taxInput = row.querySelector('input[name="fromdb_servicetax"]');
                const discountInput = row.querySelector('input[name="fromdb_servicediscount"]');
                const quantityInput = row.querySelector('input[name="fromdb_servicequantity"]');
                
                if (valueInput && taxInput && discountInput && quantityInput) {
                    const value = parseFloat(valueInput.value) || 0;
                    const tax = parseFloat(taxInput.value) || 0;
                    const discount = parseFloat(discountInput.value) || 0;
                    const quantity = parseFloat(quantityInput.value) || 1; // Default to 1 if not specified
                    
                    // Calculate individual values with quantity
                    const totalValue = value * quantity;
                    const discountValue = totalValue * (discount / 100);
                    const taxableValue = totalValue - discountValue;
                    const taxValue = taxableValue * (tax / 100);
                    
                    // Add to totals
                    subtotal += totalValue;
                    discountAmount += discountValue;
                    taxableAmount += taxableValue;
                    taxAmount += taxValue;
                }
            });
            
            // From user services
            document.querySelectorAll('tbody[data-repeater-list="fromuser-service"] tr').forEach(row => {
                const valueInput = row.querySelector('input[name="fromuser_servicevalue"]');
                const taxInput = row.querySelector('input[name="fromuser_servicetax"]');
                const discountInput = row.querySelector('input[name="fromuser_servicediscount"]');
                const quantityInput = row.querySelector('input[name="fromuser_servicequantity"]');
                
                if (valueInput && taxInput && discountInput && quantityInput) {
                    const value = parseFloat(valueInput.value) || 0;
                    const tax = parseFloat(taxInput.value) || 0;
                    const discount = parseFloat(discountInput.value) || 0;
                    const quantity = parseFloat(quantityInput.value) || 1; // Default to 1 if not specified
                    
                    // Calculate individual values with quantity
                    const totalValue = value * quantity;
                    const discountValue = totalValue * (discount / 100);
                    const taxableValue = totalValue - discountValue;
                    const taxValue = taxableValue * (tax / 100);
                    
                    // Add to totals
                    subtotal += totalValue;
                    discountAmount += discountValue;
                    taxableAmount += taxableValue;
                    taxAmount += taxValue;
                }
            });
            
            // Calculate part amounts
            // From database parts
            document.querySelectorAll('tbody[data-repeater-list="fromdb-part"] tr').forEach(row => {
                const valueInput = row.querySelector('input[name="fromdb_partvalue"]');
                const taxInput = row.querySelector('input[name="fromdb_parttax"]');
                const discountInput = row.querySelector('input[name="fromdb_partdiscount"]');
                const quantityInput = row.querySelector('input[name="fromdb_partquantity"]');
                
                if (valueInput && taxInput && discountInput && quantityInput) {
                    const value = parseFloat(valueInput.value) || 0;
                    const tax = parseFloat(taxInput.value) || 0;
                    const discount = parseFloat(discountInput.value) || 0;
                    const quantity = parseFloat(quantityInput.value) || 1; // Default to 1 if not specified
                    
                    // Calculate individual values with quantity
                    const totalValue = value * quantity;
                    const discountValue = totalValue * (discount / 100);
                    const taxableValue = totalValue - discountValue;
                    const taxValue = taxableValue * (tax / 100);
                    
                    // Add to totals
                    subtotal += totalValue;
                    discountAmount += discountValue;
                    taxableAmount += taxableValue;
                    taxAmount += taxValue;
                }
            });
            
            // From user parts
            document.querySelectorAll('tbody[data-repeater-list="fromuser-part"] tr').forEach(row => {
                const valueInput = row.querySelector('input[name="fromuser_partvalue"]');
                const taxInput = row.querySelector('input[name="fromuser_parttax"]');
                const discountInput = row.querySelector('input[name="fromuser_partdiscount"]');
                const quantityInput = row.querySelector('input[name="fromuser_partquantity"]');
                
                if (valueInput && taxInput && discountInput && quantityInput) {
                    const value = parseFloat(valueInput.value) || 0;
                    const tax = parseFloat(taxInput.value) || 0;
                    const discount = parseFloat(discountInput.value) || 0;
                    const quantity = parseFloat(quantityInput.value) || 1; // Default to 1 if not specified
                    
                    // Calculate individual values with quantity
                    const totalValue = value * quantity;
                    const discountValue = totalValue * (discount / 100);
                    const taxableValue = totalValue - discountValue;
                    const taxValue = taxableValue * (tax / 100);
                    
                    // Add to totals
                    subtotal += totalValue;
                    discountAmount += discountValue;
                    taxableAmount += taxableValue;
                    taxAmount += taxValue;
                }
            });
            
            // Calculate total
            const totalAmount = taxableAmount + taxAmount;
            
            // Format currency values
            const formatCurrency = (value) => {
                return 'INR ' + value.toFixed(2);
            };
            
            // Update summary display
            document.getElementById('summary-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('summary-discount').textContent = formatCurrency(discountAmount);
            document.getElementById('summary-taxable').textContent = formatCurrency(taxableAmount);
            document.getElementById('summary-tax').textContent = formatCurrency(taxAmount);
            document.getElementById('summary-total').textContent = formatCurrency(totalAmount);
            
            // Set the total amount in the hidden field for database storage
            document.getElementById('estimate-total-amount').value = totalAmount.toFixed(2);
            
        }
        
        // Add event listeners to update summary when values change
        document.addEventListener('input', function(e) {
            if (e.target && (e.target.name.includes("value") || e.target.name.includes("tax") || e.target.name.includes("discount") || e.target.name.includes("quantity"))) {
                updateEstimateSummary();
            }
            
            // Set default quantity to 1 if empty
            if (e.target && e.target.name.includes("quantity") && (e.target.value === "" || e.target.value === "0")) {
                e.target.value = 1;
                updateEstimateSummary();
            }
            
            // When entering a service or part name manually, ensure quantity is set
            if (e.target && (e.target.name === "fromuser_servicename" || e.target.name === "fromuser_partname")) {
                const row = e.target.closest('tr');
                if (row) {
                    const quantityInput = row.querySelector('input[name$="quantity"]');
                    if (quantityInput && (quantityInput.value === "" || quantityInput.value === "0")) {
                        quantityInput.value = 1;
                        updateEstimateSummary();
                    }
                }
            }
        });
        
        // Add change event listener for dropdowns
        document.addEventListener('change', function(e) {
            // When selecting a service or part from dropdown, ensure quantity is set
            if (e.target && (e.target.name === "fromdb_servicename" || e.target.name === "fromdb_partname")) {
                const row = e.target.closest('tr');
                if (row) {
                    const quantityInput = row.querySelector('input[name$="quantity"]');
                    if (quantityInput && (quantityInput.value === "" || quantityInput.value === "0")) {
                        quantityInput.value = 1;
                        quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        });
        
        // Initialize all repeaters
        initRepeater('fromdb-service', 'fromdb-service', 'fromdb-service');
        initRepeater('fromuser-service', 'fromuser-service', 'fromuser-service');
        initRepeater('fromdb-part', 'fromdb-part', 'fromdb-part');
        initRepeater('fromuser-part', 'fromuser-part', 'fromuser-part');
        
        // Initialize Select2 for searchable dropdowns
        function initializeSelect2Ce() {
            $('.select2-searchable').each(function() {
                if (!$(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2({
                        dropdownParent: $(this).parent(),
                        width: '100%',
                        placeholder: 'Search and select...',
                        allowClear: true
                    });
                }
            });
        }
        
        // Track selected options to prevent duplicates
        let selectedServices = new Set();
        let selectedParts = new Set();
        
        // Function to update available options
        function updateAvailableOptions() {
            // Clear the tracking sets first
            selectedServices.clear();
            selectedParts.clear();
            
            // Collect all currently selected values
            $('select[name="fromdb_servicename"]').each(function() {
                const value = $(this).val();
                if (value) selectedServices.add(value);
            });
            
            $('select[name="fromdb_partname"]').each(function() {
                const value = $(this).val();
                if (value) selectedParts.add(value);
            });
            
            // Now update all dropdowns
            $('select[name="fromdb_servicename"]').each(function() {
                const currentValue = $(this).val();
                
                $(this).find('option').each(function() {
                    const optionValue = $(this).attr('value');
                    if (optionValue && selectedServices.has(optionValue) && optionValue !== currentValue) {
                        $(this).prop('disabled', true);
                    } else {
                        $(this).prop('disabled', false);
                    }
                });
                
                // Refresh Select2 to reflect the changes
                if ($(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2('destroy').select2({
                        dropdownParent: $(this).parent(),
                        width: '100%',
                        placeholder: 'Search and select...',
                        allowClear: true
                    });
                }
            });
            
            // For parts
            $('select[name="fromdb_partname"]').each(function() {
                const currentValue = $(this).val();
                
                $(this).find('option').each(function() {
                    const optionValue = $(this).attr('value');
                    if (optionValue && selectedParts.has(optionValue) && optionValue !== currentValue) {
                        $(this).prop('disabled', true);
                    } else {
                        $(this).prop('disabled', false);
                    }
                });
                
                // Refresh Select2 to reflect the changes
                if ($(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2('destroy').select2({
                        dropdownParent: $(this).parent(),
                        width: '100%',
                        placeholder: 'Search and select...',
                        allowClear: true
                    });
                }
            });
        }
        
        // Initialize Select2 on page load
        initializeSelect2Ce();
        updateAvailableOptions();
        
        // Re-initialize Select2 when new rows are added
        $(document).on('repeater-created', function() {
            setTimeout(function() {
                initializeSelect2Ce();
                updateAvailableOptions();
            }, 100);
        });
        
        // Update available options when selections change
        $(document).on('change', 'select[name="fromdb_servicename"], select[name="fromdb_partname"]', function() {
            updateAvailableOptions();
        });
        
        // When a row is deleted, remove its selection from the tracking sets
        $(document).on('click', '[data-repeater-delete]', function() {
            const row = $(this).closest('[data-repeater-item]');
            const serviceSelect = row.find('select[name="fromdb_servicename"]');
            const partSelect = row.find('select[name="fromdb_partname"]');
            
            if (serviceSelect.length) {
                const serviceValue = serviceSelect.val();
                if (serviceValue) selectedServices.delete(serviceValue);
            }
            
            if (partSelect.length) {
                const partValue = partSelect.val();
                if (partValue) selectedParts.delete(partValue);
            }
            
            // Update options after a short delay to ensure DOM is updated
            setTimeout(updateAvailableOptions, 100);
        });
        
        // Initialize PO date field as empty
        const podateInput = document.getElementById('podate');
        if (podateInput) {
            // Clear any default value
            podateInput.value = '';
            
            // Add placeholder attribute
            podateInput.setAttribute('placeholder', ' ');
            
            // Add event listeners to handle empty state
            podateInput.addEventListener('change', function() {
                if (this.value) {
                    this.classList.remove('empty-date');
                } else {
                    this.classList.add('empty-date');
                }
            });
        }
        
        // Calculate summary on page load
        updateEstimateSummary();
        initRepeater('fromuser-part', 'fromuser-part', 'fromuser-part');
        

        // ----------------------- Auto-populate Fields ----------------------- //
        
        document.addEventListener('change', function (e) {
            // For inventory parts
            if (e.target && e.target.matches('select[name="fromdb_partname"]')) {
                const productId = e.target.value;
                const row = e.target.closest('tr');

                if (productId) {
                    fetch(`/g-inv-current-stock/${productId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status) {
                                // Set values
                                const valueInput = row.querySelector('input[name="fromdb_partvalue"]');
                                const taxInput = row.querySelector('input[name="fromdb_parttax"]');
                                const discountInput = row.querySelector('input[name="fromdb_partdiscount"]');
                                
                                valueInput.value = data.data.price || 0;
                                taxInput.value = data.data.gst || 0;
                                discountInput.value = data.data.discount || 0;
                                
                                // Trigger change events to update calculations
                                valueInput.dispatchEvent(new Event('input', { bubbles: true }));
                                taxInput.dispatchEvent(new Event('input', { bubbles: true }));
                                discountInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Update estimate summary
                                updateEstimateSummary();
                                // Trigger change events to update calculations
                                valueInput.dispatchEvent(new Event('input', { bubbles: true }));
                                taxInput.dispatchEvent(new Event('input', { bubbles: true }));
                                discountInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Update estimate summary
                                updateEstimateSummary();
                                
                                // Trigger change events to update calculations
                                valueInput.dispatchEvent(new Event('input', { bubbles: true }));
                                taxInput.dispatchEvent(new Event('input', { bubbles: true }));
                                discountInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Update estimate summary
                                updateEstimateSummary();
                            } else {
                                showToast('info', data.message || 'Unable to fetch product details');
                            }
                        })
                        .catch(error => {
                            showToast('error', `Something went wrong: ${error}`);
                        });
                }
            }

            // For inventory service
            if (e.target && e.target.matches('select[name="fromdb_servicename"]')) {
                const serviceId = e.target.value;
                const row = e.target.closest('tr');

                if (serviceId) {
                    fetch(`/g-inv-service/${serviceId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status) {
                                // Set values
                                const valueInput = row.querySelector('input[name="fromdb_servicevalue"]');
                                const taxInput = row.querySelector('input[name="fromdb_servicetax"]');
                                const discountInput = row.querySelector('input[name="fromdb_servicediscount"]');
                                
                                valueInput.value = data.data.price || 0;
                                taxInput.value = data.data.gst || 0;
                                discountInput.value = data.data.discount || 0;
                                // Trigger change events to update calculations
                                valueInput.dispatchEvent(new Event('input', { bubbles: true }));
                                taxInput.dispatchEvent(new Event('input', { bubbles: true }));
                                discountInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Update estimate summary
                                updateEstimateSummary();
                                // Trigger change events to update calculations
                                valueInput.dispatchEvent(new Event('input', { bubbles: true }));
                                taxInput.dispatchEvent(new Event('input', { bubbles: true }));
                                discountInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Update estimate summary
                                updateEstimateSummary();
                                
                                // Trigger change events to update calculations
                                valueInput.dispatchEvent(new Event('input', { bubbles: true }));
                                taxInput.dispatchEvent(new Event('input', { bubbles: true }));
                                discountInput.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Update estimate summary
                                updateEstimateSummary();
                            } else {
                                showToast('info', data.message || 'Unable to fetch service details');
                            }
                        })
                        .catch(error => {
                            showToast('error', `Something went wrong: ${error}`);
                        });
                }
            }
        });

    });
    
    // Load Select2 JavaScript
    $.getScript('https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js', function() {
        // Initialize Select2 after the library is loaded
        initializeSelect2Ce();
        updateAvailableOptions();
    });
</script>
{% endblock %}
