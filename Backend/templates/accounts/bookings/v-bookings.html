{% extends "index.html" %}

{% block title %}Booking Details - {{ booking_obj.id }}{% endblock %}

{% block style %}
<style> 
    
    :root {
        --primary-color: #4361ee;
        --primary-light: #e9e7fd;
        --success-color: #28c76f;
        --warning-color: #ff9f43;
        --danger-color: #ea5455;
        --border-color: #e0e0e0;
        --card-shadow: 0 2px 8px 0 rgba(99, 99, 99, 0.1);
        --transition: all 0.3s ease;
    }

    .card {
        border: none;
        border-radius: 0.35rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        margin-bottom: 0.75rem;
    }
    /* shri */
    .title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0;
    }
    .content-header-title {
        display: inline-block;
        margin-right: 1px;
        vertical-align: middle;
    }
    .breadcrumb-wrapper {
    display: inline-block;
    vertical-align: middle;
    margin-top: -4px; /* Adjust as needed */
    }
    /* shri */
    .card:hover {
        box-shadow: 0 4px 25px 0 rgba(0, 0, 0, 0.1);
    }

    .card-body {
        padding: 1rem;
    }

    .section-divider {
        border-top: 1px solid var(--border-color);
        margin: 2rem 0 1.5rem;
        position: relative;
    }
    
    .section-divider span {
        position: absolute;
        top: -12px;
        left: 15px;
        background: white;
        padding: 0 15px;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .info-card {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .info-card:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, #4361ee, #3a56d4);
        border-radius: 4px 0 0 4px;
    }
    
    .info-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        background-color: #f8f9fa;
    }
    
    .info-card:last-child {
        margin-bottom: 0;
    }

    .info-card p {
        margin-bottom: 0.5rem;
        line-height: 1.4;
        color: #5e6e82;
        font-size: 0.95rem;
    }
    
    .info-card .row.g-2 > [class*='col-'] {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }

    .text-muted {
        color: #6e6b7b !important;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        margin-bottom: 0.25rem !important;
        display: block;
    }
    
    .info-card .data-text {
        font-size: 0.75rem;
        color: #4a4a4a;
        font-weight: 400;
    }

    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 2rem;
        border-left: 2px solid #e0e0e0;
        padding-left: 2rem;
    }

    .timeline-item:last-child {
        border-left-color: transparent;
        padding-bottom: 0;
    }
    
    .timeline .timeline-item:last-of-type:after {
        content: none;
    }

    .timeline-point {
        position: absolute;
        left: -1.5rem;
        top: 0;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
        z-index: 1;
    }

    .timeline-point-primary {
        background-color: var(--primary-color);
        box-shadow: 0 4px 8px 0 rgba(115, 103, 240, 0.4);
    }

    .timeline-point-success {
        background-color: var(--success-color);
        box-shadow: 0 4px 8px 0 rgba(40, 199, 111, 0.4);
    }


    .timeline-point-warning {
        background-color: var(--warning-color);
        box-shadow: 0 4px 8px 0 rgba(255, 159, 67, 0.4);
    }

    .timeline-point-danger {
        background-color: var(--danger-color);
        box-shadow: 0 4px 8px 0 rgba(234, 84, 85, 0.4);
    }

    .timeline-event {
        background: white;
        padding: 1.25rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.05);
        transition: var(--transition);
    }

    .timeline-event:hover {
        transform: translateX(5px);
    }

    .timeline-event h6 {
        margin: 0 0 0.5rem 0;
        color: #5e5873;
        font-weight: 600;
    }

    .timeline-event p {
        margin: 0;
        color: #6e6b7b;
        font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .card-body {
            padding: 1.25rem;
        }
    }
</style>
{% endblock %}

{% load custom_filters %}
{% block content %}
<div class="app-content content">
    <div class="content-overlay"></div>
    <div class="header-navbar-shadow"></div>
    <div class="content-wrapper container-xxl p-0">
        <div class="content-header row">
            <div class="content-header-left col-md-7 col-12 mb-2">
                <div class="row breadcrumbs-top">
                    <div class="col-12">
                        <h2 class="content-header-title float-start mb-0 title">Accounts</h2>
                            <div class="breadcrumb-wrapper">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="{% url 'r-accounts-bookings' %}">List Bookings</a>
                                    </li>
                                    <li class="breadcrumb-item active">Booking Details
                                    </li>
                                </ol>
                            </div>
                    </div>
                </div>
            </div>
            <div class="content-header-right text-md-end col-md-5 col-12">
                <div class="mb-1 breadcrumb-right">
                    <div class="dropdown">
                        <button class="btn-icon btn btn-success btn-round btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i data-feather="grid"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="{% url 'u-accounts-bookings' booking_obj.id %}">
                                <i class="me-1" data-feather="edit-2"></i>
                                <span class="align-middle">Update Booking</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content-body">
            <section id="v-accounts-bookings">
                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="card">                            
                            <div class="card-header">
                                <div class="d-flex align-items-center justify-content-center">
                                    <h6 class="card-title mb-0 fw-600">
                                        <i class="fas fa-check-circle text-success me-25"></i>
                                        {{ booking_obj.latest_status }}
                                        {% if is_jobcard %}
                                        #{{jobcard_number}}, 
                                        <span class="badge rounded-pill badge-light-{% if jobcard_status == 'open' %}success{% else %}danger{% endif %}">{{jobcard_status|upper}}</span>
                                        {% endif %}
                                    </h6>
                                </div>
                                <div class="d-flex align-items-center" style="padding-right: 5px; border-right: 3px solid {% if booking_obj.created_at|is_within_24_hours %}#198754{% else %}#dc3545{% endif %};">
                                    <i data-feather="clock" class="me-25"></i>                                                    
                                    <small class="align-items-center">{{ booking_obj.created_at|timesince }}</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Booking Details -->
                                    <div class="col-12 col-lg-6 mb-1">
                                        <div class="info-card h-100">
                                            <p class="mb-1 text-muted small"><i class="fas fa-calendar-alt me-2"></i>Booking Details</p>
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-hashtag me-1"></i>Booking ID</p>
                                                    <p class="data-text">{{ booking_obj.id }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="far fa-calendar-alt me-1"></i>Date</p>
                                                    <p class="data-text">{{ booking_obj.booking_date|default:'-' }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="far fa-clock me-1"></i>Time Slot</p>
                                                    <p class="data-text">{{ booking_obj.booking_slot|default:'-' }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-rupee-sign me-1"></i>Amount</p>
                                                    <p class="data-text">
                                                        {% if booking_obj.booking_amount %}
                                                            â‚¹{{ booking_obj.booking_amount|floatformat:2 }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Customer Details -->
                                    <div class="col-12 col-lg-6 mb-1">
                                        <div class="info-card h-100">
                                            <p class="mb-1 text-muted small"><i class="fas fa-user me-2"></i>Customer Details</p>
                                            <div class="row g-1">
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-phone-alt me-1"></i>Phone</p>
                                                    <p class="data-text">
                                                        <a {% if booking_obj.subscriber.phone %}href="tel:{{ booking_obj.subscriber.phone }}"{% endif %}>
                                                            {{ booking_obj.subscriber.phone }}
                                                        </a>
                                                    </p>
                                                </div>
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-motorcycle me-1"></i>Vehicle</p>
                                                    <p class="data-text">
                                                        {% if booking_obj.subscribervehicle %}
                                                        {{ booking_obj.subscribervehicle.model.brand.name }}
                                                        {{ booking_obj.subscribervehicle.model.name }}
                                                        {{ booking_obj.subscribervehicle.model.cc.name }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                
                                                <div class="col-6">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-map-marker-alt me-1"></i>Address</p>
                                                    <p class="data-text">
                                                        {% if booking_obj.subscriberaddress %}
                                                        {{ booking_obj.subscriberaddress.address }}
                                                        {{ booking_obj.subscriberaddress.pincode }}
                                                        {{ booking_obj.subscriberaddress.city.name }}
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if usertype != 'garage' %}
                                    <!-- Garage Details -->
                                    <div class="col-12 mb-1">
                                        <div class="info-card">
                                            <p class="mb-1 text-muted small"><i class="fas fa-warehouse me-2"></i>Garage Details</p>
                                            <div class="row g-1">
                                                <div class="col-6 col-md-3">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-store me-1"></i>Garage Name</p>
                                                    <p class="data-text">{{ booking_obj.garage.name|default:'-' }}</p>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-user me-1"></i>Owner</p>
                                                    <p class="data-text">
                                                        {% with garage_user=booking_obj.garage.rel_garage_user.first %}
                                                            {% if garage_user %}
                                                                {{ garage_user.user.name|default:garage_user.user.email|default:'-' }}
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        {% endwith %}
                                                    </p>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-phone-alt me-1"></i>Phone</p>
                                                    <p class="data-text">
                                                        {% if booking_obj.garage.phone %}
                                                            <a href="tel:{{ booking_obj.garage.phone }}">
                                                                {{ booking_obj.garage.phone }}
                                                            </a>
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <p class="mb-1 small text-muted data-text"><i class="far fa-envelope me-1"></i>Email</p>
                                                    <p class="data-text">
                                                        {% if booking_obj.garage.email %}
                                                            <a href="mailto:{{ booking_obj.garage.email }}">
                                                                {{ booking_obj.garage.email }}
                                                            </a>
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div class="col-12">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-map-marker-alt me-1"></i>Address</p>
                                                    <p class="data-text">
                                                        {% if booking_obj.garage.address %}
                                                            {{ booking_obj.garage.address.address_line1|default:'' }}
                                                            {% if booking_obj.garage.address.landmark %}, {{ booking_obj.garage.address.landmark }}{% endif %}
                                                            {% if booking_obj.garage.address.city %}, {{ booking_obj.garage.address.city.name|default:'' }}{% endif %}
                                                            {% if booking_obj.garage.address.pincode %}, {{ booking_obj.garage.address.pincode }}{% endif %}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                {% if booking_obj.garage.gst_number %}
                                                <div class="col-6 col-md-3">
                                                    <p class="mb-1 small text-muted data-text"><i class="fas fa-file-invoice me-1"></i>GST Number</p>
                                                    <p class="data-text">{{ booking_obj.garage.gst_number }}</p>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Additional Information -->
                                    <div class="col-12 mb-1">
                                        <div class="info-card">
                                            <p class="mb-1 text-muted small"><i class="fas fa-info-circle me-2"></i>Additional Information</p>
                                            <p class="data-text">{{ booking_obj.suggestion|default:'No suggestions provided' }}</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="action-buttons">
                                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                                        {% for status in booking_status_choices %}
                                            {% if status.parentid == booking_obj.latest_status_id %}
                                                {% if status.name == 'job_card_created' %}
                                                <button type="button" class="btn btn-sm btn-success" id="createJobCardBtn">
                                                    <i class="fas fa-file-alt me-25"></i> Create Job Card
                                                </button> 
                                                {% else %}
                                                    {% if is_jobcard %}
                                                        {% if jobcard_status == 'open' %}
                                                            <a href="{% url 'u-txn-job-sheets' jobcard_id %}" class="btn btn-sm btn-warning">
                                                                <i class="fas fa-file-alt me-25"></i> Open Job Card
                                                            </a>
                                                        {% else %}                                                        
                                                            <a href="{% url 'v-txn-job-sheets' jobcard_id %}" class="btn btn-sm btn-primary">
                                                                <i class="fas fa-file-alt me-25"></i> View Job Card
                                                            </a>
                                                        {% endif %}
                                                    {% else %}
                                                    <button type="button" class="btn btn-sm btn-success" data-newstatus="{{status.name}}">
                                                        <i class="fas fa-check me-25"></i> {{status.displayname}}
                                                    </button>                                                        
                                                    {% endif %}                                                
                                                {% endif %}
                                                {% if status.name == 'pickup_assigned' %}
                                                <button type="button" class="btn btn-sm btn-outline-danger" data-skipstatus="{{status.name}}">
                                                    <i class="fas fa-forward me-25"></i> Skip {{status.displayname}}
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4">
                        <div class="card">
                            <div class="card-body">
                                <!-- Timeline -->
                                <div class="section-divider">
                                    <span>Timeline</span>
                                </div>
                                <div class="timeline" id="booking-timeline">
                                    {% for entry in timeline_entries %}
                                        <div class="timeline-item {% if forloop.first %}current-status{% endif %}" data-status="{{ entry.status.name }}">
                                            <div class="timeline-point {% if forloop.first %}timeline-point-primary{% else %}timeline-point-secondary{% endif %}">
                                                <i class="fas {% if forloop.first %}fa-clock{% else %}fa-check{% endif %}"></i>
                                            </div>
                                            <div class="timeline-event">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="{% if not forloop.last %}text-muted{% endif %}">
                                                        {{ entry.status.displayname|default:entry.status.name|title }}
                                                    </h6>
                                                    <div class="font-small-2">{{ entry.created_at|date:"d M Y H:i" }}</div>
                                                </div>
                                                {% if entry.remark %}
                                                <div class="font-small-2">{{ entry.remark }}</div>
                                                {% endif %}
                                                {% if entry.notes %}
                                                <div class="font-small-2">{{ entry.notes }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="text-center text-muted py-3">
                                            No timeline entries found.
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
// Function to handle skip status (UI only update)
function handleSkipStatus(button, statusToUpdate) {
    const buttonsContainer = button.closest('.d-flex');
    
    // Update the UI first for instant feedback
    if (statusToUpdate === 'pickup_assigned') {
        buttonsContainer.innerHTML = `
            <button type="button" class="btn btn-sm btn-success" data-newstatus="mechanic_assigned">
                <i class="fas fa-check me-25"></i> Mechanic Assigned
            </button>
        `;
    } else {
        const displayName = button.textContent.trim().replace('Skip ', '');
        buttonsContainer.innerHTML = `
            <button type="button" class="btn btn-sm btn-success" data-newstatus="${statusToUpdate}">
                <i class="fas fa-check me-25"></i> ${displayName}
            </button>
        `;
    }
    
    // Show success message after UI update
    toastr['success']('Status skipped successfully', 'SUCCESS', {
        closeButton: true,
        tapToDismiss: false,
        progressBar: true,
        showMethod: 'fadeIn',
        hideMethod: 'fadeOut',
        timeOut: 2000
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle status update buttons
    document.querySelector('.action-buttons').addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;
        
        // Check which type of button was clicked
        const newStatus = button.dataset.newstatus;
        const skipStatus = button.dataset.skipstatus;
        
        if (!newStatus && !skipStatus) return; // Not a status button
        
        const statusToUpdate = newStatus || skipStatus;
        const isSkipAction = !!skipStatus;
        
        // If it's a skip action, handle it differently
        if (isSkipAction) {
            Swal.fire({
                title: 'Skip Status?',
                text: 'Do you want to skip this status and move to the next one?',
                // icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, skip it!',
                cancelButtonText: 'No, cancel!',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    handleSkipStatus(button, statusToUpdate);
                }
            });
            return;
        }
        
        // For normal status updates
        Swal.fire({
            title: 'Update Status?',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: statusToUpdate === 'pickup_assigned' ? 'Yes, assign crew!' : 
                             statusToUpdate === 'mechanic_assigned' ? 'Yes, assign mechanic!' : 'Yes, update it!',
            cancelButtonText: 'No, cancel!',
            reverseButtons: true,
            html: statusToUpdate === 'pickup_assigned' ? 
                `
                <div>
                    <select class="form-select" id="crewSelect" required>
                        <option value="" selected disabled>Select a crew member</option>
                        {% for crew_member in crew %}
                            <option value="{{ crew_member.id }}">{{ crew_member.firstname }} {{ crew_member.lastname }}</option>
                        {% endfor %}
                    </select>
                </div>
                ` : statusToUpdate === 'mechanic_assigned' ?
                `
                <div>
                    <select class="form-select" id="mechanicSelect" required>
                        <option value="" selected disabled>Select a mechanic</option>
                        {% for mechanic in mechanic %}
                            <option value="{{ mechanic.id }}">{{ mechanic.firstname }} {{ mechanic.lastname }}</option>
                        {% endfor %}
                    </select>
                </div>
                ` : `Are you sure you want to update status to ${statusToUpdate.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}?`,
            preConfirm: () => {
                if (statusToUpdate === 'pickup_assigned') {
                    const crewSelect = document.getElementById('crewSelect');
                    if (!crewSelect || !crewSelect.value) {
                        Swal.showValidationMessage('Please select a crew member');
                        return false;
                    }
                    return { type: 'crew', id: crewSelect.value };
                } else if (statusToUpdate === 'mechanic_assigned') {
                    const mechanicSelect = document.getElementById('mechanicSelect');
                    if (!mechanicSelect || !mechanicSelect.value) {
                        Swal.showValidationMessage('Please select a mechanic');
                        return false;
                    }
                    return { type: 'mechanic', id: mechanicSelect.value };
                }
                return true;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading state
                const originalHTML = button.innerHTML;
                const buttonsContainer = button.closest('.d-flex');
                const allButtons = buttonsContainer.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                });
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-25"></i> Updating...';

                // Prepare the data object
                const data = {
                    booking_id: '{{ booking_obj.id }}',
                    status: statusToUpdate,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                };

                // Add remark based on status
                if (result.value) {
                    if (statusToUpdate === 'pickup_assigned' && result.value.type === 'crew') {
                        data.remark = result.value.id;
                    } else if (statusToUpdate === 'mechanic_assigned' && result.value.type === 'mechanic') {
                        data.remark = result.value.id;
                    }
                }

                // Initialize controller and timeout for the API call
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                // Make the API call with optimized settings
                fetch("{% url 'api-subscriber-booking-update-status' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify(data),
                    signal: controller.signal
                })
                .finally(() => clearTimeout(timeoutId))
                .then(response => response.json())
                .then(data => {
                    if (data.status === true) {
                        // Show success message using toastr
                        toastr['success'](data.message || 'Status updated successfully', 'SUCCESS', {
                            closeButton: true,
                            tapToDismiss: false,
                            progressBar: true,
                            showMethod: 'fadeIn',
                            hideMethod: 'fadeOut',
                            timeOut: 2000,
                            onHidden: function() {
                                location.reload();
                            }
                        });
                    } else {
                        throw new Error(data.message || 'Failed to update status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Re-enable buttons
                    allButtons.forEach(btn => {
                        btn.disabled = false;
                    });
                    button.innerHTML = originalHTML;
                    
                    // Show error message
                    toastr['error'](error.message || 'An error occurred while updating the status', 'ERROR', {
                        closeButton: true,
                        tapToDismiss: false,
                        progressBar: true,
                        showMethod: 'fadeIn',
                        hideMethod: 'fadeOut',
                        timeOut: 5000
                    });
                });
            }
        });
    });

    // Handle job card creation button click
    const createJobCardBtn = document.getElementById('createJobCardBtn');
    if (createJobCardBtn) {
        createJobCardBtn.addEventListener('click', function() {
            const vehicleType = `{{ booking_obj.subscribervehicle.model.vehicletype }}`;
            const bookingId = `{{ booking_obj.id }}`;
            const csrfToken = getCookie('csrftoken');

            if (!vehicleType) {
                toastr['error']('Vehicle type not found!', 'ERROR', {
                    closeButton: true,
                    tapToDismiss: false,
                    progressBar: true,
                    showMethod: 'fadeIn',
                    hideMethod: 'fadeOut',
                    timeOut: 5000
                });
                return;
            }

            Swal.fire({
                title: 'Create Job Card?',
                text: 'Are you sure you want to create job card?',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, create it!',
                cancelButtonText: 'No, cancel!',
                reverseButtons: true,
                showLoaderOnConfirm: true,
                preConfirm: async () => {
                    try {
                        createJobCardBtn.disabled = true;
                        createJobCardBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-25"></i> Creating...';
                        
                        const formData = new FormData();
                        formData.append('bookingid', bookingId);
                        formData.append('csrfmiddlewaretoken', csrfToken);

                        const response = await fetch('{% url "c-accounts-bookings-jobcard" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            // Show success message and redirect
                            Swal.fire({
                                title: 'Success!',
                                text: data.message || 'Job card created successfully!',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            throw new Error(data.message || 'Failed to create job card');
                        }
                    } catch (error) {
                        console.error('Error creating job card:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: error.message || 'An error occurred while creating job card',
                            icon: 'error'
                        });
                        createJobCardBtn.disabled = false;
                        createJobCardBtn.innerHTML = '<i class="fas fa-file-alt me-25"></i> Create Job Card';
                        return false;
                    }
                },
                allowOutsideClick: () => !Swal.isLoading()
            });
        });
    }

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

});
</script>
{% endblock %}