{% extends "index.html" %}
{% load static %}

{% block title %}r-staff{% endblock %}

{% block style %}
<style>
    .table tbody tr:nth-child(odd) {
        background-color: #f8f8f8;
    }
    .table tbody tr:hover {
        background-color: #f1f1f1;
    }
</style>
<style>
    :root {
        --primary: #5851e1;
        --primary-light: #eeedfb;
        --success: #5851e1;
        /* Changed from green to primary color */
        --danger: #f05252;
        --warning: #ff9f43;
        --info: #3f87f5;
        --dark: #1f2937;
        --light: #f9fafb;
        --border-radius: 0.5rem;
        --box-shadow: 0 4px 12px 0 rgba(31, 41, 55, 0.08);
    }

    /* Modern Card Styling */
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
        background: #fff;
        overflow: hidden;
        position: relative;
        z-index: 1;
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--primary);
        opacity: 0.8;
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px 0 rgba(31, 41, 55, 0.1);
    }

    .card:hover::before {
        opacity: 1;
    }

    /* Table Styles */
    .table-responsive {
        overflow-x: auto;
        border-radius: var(--border-radius);
        padding: 0;
    }

    .table {
        --bs-table-striped-bg: rgba(88, 81, 225, 0.02);
        --bs-table-hover-bg: rgba(88, 81, 225, 0.04);
        --bs-table-bg: transparent;
        margin-bottom: 0;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    /* Override bootstrap table success colors */
    .table-success {
        --bs-table-bg: rgba(88, 81, 225, 0.1) !important;
        --bs-table-striped-bg: rgba(88, 81, 225, 0.15) !important;
        --bs-table-striped-color: #1f2937 !important;
        --bs-table-active-bg: rgba(88, 81, 225, 0.2) !important;
        --bs-table-active-color: #1f2937 !important;
        --bs-table-hover-bg: rgba(88, 81, 225, 0.15) !important;
        --bs-table-hover-color: #1f2937 !important;
        color: #1f2937 !important;
        border-color: rgba(88, 81, 225, 0.2) !important;
    }

    .table> :not(caption)>*>* {
        padding: 0.85rem 1.25rem;
        vertical-align: middle;
    }

    .table thead th {
        border-bottom: 1px solid #edf2f7;
        font-weight: 600;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
        color: #64748b;
        background-color: #f8fafc;
        text-transform: uppercase;
    }

    .table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #edf2f7;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
    }

    /* Action Buttons */
    .action-btns {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .action-btns .btn {
        padding: 0.45rem 0.9rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border-width: 1px;
        font-size: 0.8rem;
    }

    .action-btns .btn i {
        font-size: 1em;
    }

    .btn-outline-primary {
        color: var(--text-primary);
        border-color: var(--text-primary);
    }

    .btn-outline-primary:hover {
        background-color: var(--text-primary);
        color: white;
    }

    .btn-outline-danger {
        color: var(--danger);
        border-color: var(--danger);
    }

    .btn-outline-danger:hover {
        background-color: var(--danger);
        color: white;
    }

    .btn-outline-info {
        color: var(--info);
        border-color: var(--info);
    }

    .btn-outline-info:hover {
        background-color: var(--info);
        color: white;
    }

    .btn-outline-secondary {
        color: #64748b;
        border-color: #e2e8f0;
    }

    .btn-outline-secondary:hover {
        background-color: #f1f5f9;
        color: #1e293b;
        border-color: #cbd5e1;
    }

    /* Search and Filter */
    .search-filter-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        background: #fff;
        padding: 1rem 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }

    .card-header {
        background: transparent;
        padding: 1.5rem;
        border-bottom: 1px solid rgba(34, 41, 47, 0.05);
    }
    
    tr.clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    tr.clickable-row:hover {
        background-color: #f8f9fa;
    }
    
    /* Prevent the checkbox from triggering row click */
    tr.clickable-row input[type="checkbox"] {
        pointer-events: auto;
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-box .input-group-text {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 4;
        border: none;
        background: transparent;
        padding: 0 1rem;
    }

    .search-box .form-control {
        padding-left: 2.8rem;
        border-radius: 6px !important;
        border: 1px solid #d8d6de;
        transition: all 0.3s;
    }

    .search-box .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 3px 10px 0 rgba(115, 103, 240, 0.1);
    }

    .filter-select {
        min-width: 150px;
        border-radius: 6px !important;
        border: 1px solid #d8d6de;
        transition: all 0.3s;
    }

    .filter-select:focus {
        border-color: var(--primary);
        box-shadow: 0 3px 10px 0 rgba(115, 103, 240, 0.1);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            gap: 1rem;
        }

        .search-filter-container {
            flex-direction: column;
            gap: 0.75rem;
        }

        .search-box,
        .filter-select {
            width: 100%;
            min-width: 100%;
        }

        .table td,
        .table th {
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }

    /* Pagination */
    .pagination {
        margin: 1.5rem 0 0 0;
        justify-content: flex-end;
    }

    .pagination .page-link {
        border: 1px solid #e0e0e0;
        margin: 0 0.25rem;
        min-width: 2.286rem;
        height: 2.286rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5e5873;
        font-weight: 500;
        transition: all 0.3s;
    }

    .pagination .page-link:hover {
        background: #f5f5f5;
        color: var(--primary);
    }

    .pagination .page-item.active .page-link {
        background: var(--primary);
        border-color: var(--primary);
        color: #fff;
        box-shadow: 0 4px 10px 0 rgba(115, 103, 240, 0.3);
    }

    .page-item .page-link {
        border-radius: 50% !important;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 2px;
        border: none;
        color: #6e6b7b;
    }

    .page-item.active .page-link {
        background-color: #7367f0;
        color: #fff;
    }

    /* Empty State */
    .empty-state {
        padding: 4rem 2rem;
        text-align: center;
        background: #f8f7fa;
        border-radius: var(--border-radius);
        margin: 1.5rem 0;
    }

    .empty-state .avatar {
        width: 100px;
        height: 100px;
        margin: 0 auto 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(115, 103, 240, 0.1) !important;
    }

    .empty-state .avatar i {
        font-size: 3rem;
        color: var(--primary);
    }

    .empty-state h4 {
        color: var(--dark);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .empty-state p {
        color: #6e6b7b;
        margin-bottom: 1.5rem;
    }

    .empty-state .btn {
        padding: 0.7rem 1.5rem;
        font-weight: 500;
        border-radius: 6px;
    }

    .empty-state .avatar {
        margin: 0 auto 1.5rem;
    }
</style>
{% endblock %}

{% load custom_filters %}
{% block content %}
<div class="app-content content" style="background: #f9fafb;">
    <div class="content-overlay"></div>
    <div class="header-navbar-shadow"></div>
    <div class="content-wrapper container-xxl">

        <div class="content-header row">
            <div class="content-header-left col-md-9 col-12 mb-2">
                <div class="row breadcrumbs-top">
                    <div class="col-12">
                        <h2 class="content-header-title mb-0">Staff</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-body">
            <!-- Responsive tables start -->
            <div class="row" id="table-responsive">
                <div class="col-12">
                    <div class="card border-0">                        
                        
                        <div class="card-header d-flex justify-content-between align-items-center border-0 pb-0">
                            <div class="d-flex align-items-center gap-2">
                                
                                <a href="{% url 'c-staff' %}"
                                    class="btn btn-sm btn-icon btn-success rounded-circle shadow-sm"
                                    data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Add Staff">
                                    <i data-feather='plus-square' class="font-medium-2"></i>
                                </a>
                                
                                {% if staff_objs %}
                                <button type="button" id="delStaff"
                                    class="btn btn-sm btn-icon btn-danger rounded-circle shadow-sm"
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    data-bs-original-title="Delete Selected">
                                    <i data-feather='trash-2' class="font-medium-2"></i>
                                </button>
                                {% endif %}

                                <a href="{% url 'r-staff' %}"
                                    class="btn btn-sm btn-icon btn-light-primary rounded-circle shadow-sm"
                                    data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Refresh">
                                    <i data-feather='refresh-cw' class="font-medium-2"></i>
                                </a>
                            </div>
                            {% if staff_objs %}
                            <div class="search-container position-relative p-2">
                                <div class="search-box position-relative">
                                    <input type="text" id="searchStaff"
                                        class="form-control form-control-lg border-0 shadow-sm rounded-pill ps-5"
                                        placeholder="Search staff..."
                                        style="min-width: 300px; background-color: #f8fafc;"
                                        oninput="searchTable('searchStaff', 'tableStaff')">
                                    <i data-feather="search" class="text-primary position-absolute"
                                        style="left: 15px; top: 50%; transform: translateY(-50%);"></i>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% if staff_objs %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tableStaff"
                                style="border: none !important;">
                                <thead style="background-color: #f8fafc !important; border: none !important;">
                                    <tr style="border: none !important; background-color: #f8fafc !important;">
                                        <th scope="col" class="text-nowrap form-check-primary lead-column"
                                            style="background-color: #f8fafc !important; border-color: #edf2f7 !important;">
                                            <input class="form-check-input me-1" type="checkbox" id="selectAll"
                                                data-bs-toggle="tooltip" data-bs-placement="top"
                                                data-bs-original-title="Select all bookings">
                                            Staff
                                        </th>
                                        <th scope="col" class="text-nowrap contact-column"
                                            style="background-color: #f8fafc !important; border-color: #edf2f7 !important;">
                                            Reference</th>
                                        <th scope="col" class="text-nowrap contact-column"
                                            style="background-color: #f8fafc !important; border-color: #edf2f7 !important;">
                                            Role</th>
                                        <th scope="col" class="text-nowrap status-column"
                                            style="background-color: #f8fafc !important; border-color: #edf2f7 !important;">
                                            Status</th> 
                                        <th scope="col" class="text-nowrap action-column"
                                            style="background-color: #f8fafc !important; border-color: #edf2f7 !important;">
                                            Availability</th>    
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for staff in staff_objs %}
                                    <tr class="clickable-row" data-href="{% url 'u-staff' staff.id %}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <form method="post" class="form-check-primary me-2">
                                                    {% csrf_token %}
                                                    <input class="form-check-input" type="checkbox" name="checkedStaff"
                                                        value="{{staff.id}}" data-bs-toggle="tooltip"
                                                        data-bs-placement="top" data-bs-original-title="Select booking">
                                                </form>
                                                <div class="d-flex flex-column">                                                    
                                                    <div class="fw-semibold">
                                                        <i data-feather="user" class="text-primary " width="14"
                                                            height="14"></i>
                                                        {{staff.firstname}} {{staff.middlename}} {{staff.lastname}}
                                                    </div>
                                                    <div class="fw-semibold text-dark">
                                                        <i data-feather="phone" class="text-primary" width="12"
                                                            height="12"></i>
                                                        {{staff.phone}}
                                                    </div>
                                                    <div class="text-primary">
                                                        <i class="fas fa-id-card text-primary" style="font-size: 12px;"></i>
                                                        {{ staff.aadhar }}
                                                    </div>
                                                </div>                                                                                                
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">                                                    
                                                <div class="fw-semibold">
                                                    <i data-feather="user" class="text-primary " width="14"
                                                        height="14"></i>
                                                    {{staff.reference_by_name}}
                                                </div>
                                                <div class="fw-semibold text-dark">
                                                    <i data-feather="phone" class="text-primary" width="12"
                                                        height="12"></i>
                                                    {{staff.reference_by_phone}}
                                                </div>
                                                <div class="text-primary">
                                                    <i class="fas fa-envelope text-primary" style="font-size: 12px;"></i>
                                                    {{ staff.reference_by_email }}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for role in staff.roles %}
                                                    {% if role|lower == 'mechanic' %}
                                                        <span class="badge bg-warning text-dark">{{ role|title }}</span>
                                                    {% elif role|lower == 'crew' %}
                                                        <span class="badge bg-info text-dark">{{ role|title }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ role|title }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </td>                                       
                                        <td>
                                            {% if staff.status|lower == 'active' %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if staff.availability %}
                                                <span class="badge bg-success">Available</span>
                                            {% else %}
                                                <span class="badge bg-danger">Not Available</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="text-muted fs-sm">
                                    Showing {{ staff_objs.start_index }} to {{ staff_objs.end_index }} of {{ staff_objs.paginator.count }} entries
                                </div>
                                <div>
                                    {% if staff_objs.has_other_pages %}
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination pagination-primary">

                                            <!-- First Page Link -->
                                            {% if staff_objs.number > 1 %}
                                            <li class="page-item first">
                                                <a href="?page=1&status={{ request.GET.status }}&startdate={{ request.GET.startdate }}&enddate={{ request.GET.enddate }}"
                                                    class="page-link">First</a>
                                            </li>
                                            {% else %}
                                            <li class="page-item first disabled">
                                                <span class="page-link">First</span>
                                            </li>
                                            {% endif %}

                                            <!-- Previous Page Link -->
                                            {% if staff_objs.has_previous %}
                                            <li class="page-item prev">
                                                <a href="?page={{ staff_objs.previous_page_number }}&status={{ request.GET.status }}&startdate={{ request.GET.startdate }}&enddate={{ request.GET.enddate }}"
                                                    class="page-link" aria-label="Previous"></a>
                                            </li>
                                            {% else %}
                                            <li class="page-item prev disabled">
                                                <span class="page-link" aria-label="Previous"></span>
                                            </li>
                                            {% endif %}

                                            <!-- Page Number Links (up to 3 pages around the current page) -->
                                            {% for page in staff_objs.paginator.page_range %}
                                            {% if page >= staff_objs.number|add:'-1' and page <= staff_objs.number|add:'1' %} {% if page == staff_objs.number %} <li class="page-item active">
                                                <span class="page-link">{{ page }}</span>
                                                </li>
                                                {% else %}
                                                <li class="page-item">
                                                    <a href="?page={{ page }}&status={{ request.GET.status }}&startdate={{ request.GET.startdate }}&enddate={{ request.GET.enddate }}"
                                                        class="page-link">{{ page }}</a>
                                                </li>
                                                {% endif %}
                                                {% endif %}
                                                {% endfor %}

                                                <!-- Next Page Link -->
                                                {% if staff_objs.has_next %}
                                                <li class="page-item next">
                                                    <a href="?page={{ staff_objs.next_page_number }}&status={{ request.GET.status }}&startdate={{ request.GET.startdate }}&enddate={{ request.GET.enddate }}"
                                                        class="page-link" aria-label="Next"></a>
                                                </li>
                                                {% else %}
                                                <li class="page-item next disabled">
                                                    <span class="page-link" aria-label="Next"></span>
                                                </li>
                                                {% endif %}

                                                <!-- Last Page Link -->
                                                {% if staff_objs.number < staff_objs.paginator.num_pages %} <li class="page-item last">
                                                    <a href="?page={{ staff_objs.paginator.num_pages }}&status={{ request.GET.status }}&startdate={{ request.GET.startdate }}&enddate={{ request.GET.enddate }}"
                                                        class="page-link">Last</a>
                                                    </li>
                                                {% else %}
                                                <li class="page-item last disabled">
                                                    <span class="page-link">Last</span>
                                                </li>
                                                {% endif %}

                                        </ul>
                                    </nav>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="avatar bg-light-primary bg-lighten-4" style="width: 100px; height: 100px;">
                                <span class="avatar-content">
                                    <i data-feather='users' class="font-large-2 text-primary"></i>
                                </span>
                            </div>
                            <h4 class="mt-2 mb-1">No Staff Found</h4>
                            <p class="text-muted mb-3">You don't have any staff yet. Start by adding your first staff to
                                see it here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Responsive tables end -->
</div>
</div>
</div>
{% endblock %}

{% block script %}
<!-- Custom Scripts -->
<script src="{% static 'custom-assets/js/tableSearch.js' %}"></script>
<script src="{% static 'custom-assets/js/selectAllCheckbox.js' %}"></script>
<script src="{% static 'custom-assets/js/deleteConfirmation.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Initialize feather icons
    feather.replace();
        
    // Handle delete button click
    const delStaffButton = document.getElementById("delStaff");
    delStaffButton?.addEventListener("click", function () {
        let ids = [];
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        document.querySelectorAll('input[name="checkedStaff"]:checked').forEach(function (input) {
            ids.push(input.value);
        });
        // Prepare data and URL for the AJAX request
        const data = {
            id: ids,
            csrfmiddlewaretoken: csrfToken
        };
        const ajaxUrl = "{% url 'd-staff' %}";
        
        deleteConfirmation(data, ajaxUrl);
    });

    // Make table rows clickable
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on:
            // 1. Checkbox inputs
            // 2. Labels
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') {
                return;
            }
            
            // Only navigate if the row has a valid href
            if (this.dataset.href && this.dataset.href !== '#') {
                window.location.href = this.dataset.href;
            }
        });
    });
});
</script>
{% endblock %}